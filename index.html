<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工业检测系统</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 220px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
        }
        
        .mode-selector {
            display: flex;
            flex-direction: column;
            padding: 15px 10px;
        }
        
        .mode-btn {
            padding: 12px 15px;
            margin: 5px 0;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
        }
        
        .mode-btn i {
            margin-right: 10px;
        }
        
        .mode-btn:hover {
            background: #3d566e;
        }
        
        .mode-btn.active {
            background: var(--primary-color);
            font-weight: 500;
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        h1 {
            color: #2c3e50;
            margin: 0;
        }
        
        /* 上传区域 */
        .upload-container {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 2px dashed #bdc3c7;
            padding: 40px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .upload-area.highlight {
            border-color: var(--primary-color);
            background-color: #f8fafb;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .upload-text {
            margin-bottom: 5px;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .upload-hint {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* 预览区域 */
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
        }
        
        .image-container {
            position: relative;
            padding-top: 100%; /* 1:1比例 */
            overflow: hidden;
        }
        
        .image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-info {
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .filename {
            font-weight: 500;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status.waiting {
            background: #f1f2f6;
            color: #7f8c8d;
        }
        
        .status.processing {
            background: #fff4e6;
            color: #e67e22;
        }
        
        .status.success {
            background: #e8f8f5;
            color: #27ae60;
        }
        
        .status.error {
            background: #fdecea;
            color: #e74c3c;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn i {
            margin-right: 6px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn:disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* 进度条 */
        .progress-container {
            margin-top: 15px;
        }
        
        .progress-bar {
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        /* 批量操作栏 */
        .batch-actions {
            display: none;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .batch-info {
            display: flex;
            align-items: center;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 15px 0;
            }
            .mode-selector {
                flex-direction: row;
                overflow-x: auto;
                padding: 10px;
            }
            .mode-btn {
                white-space: nowrap;
                margin: 0 5px;
            }
        }
    </style>
    <!-- 使用Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- JSZip库用于打包下载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <!-- 侧边导航栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>工业检测系统</h2>
        </div>
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="single">
                <i class="fas fa-image"></i>单张检测
            </button>
            <button class="mode-btn" data-mode="batch">
                <i class="fas fa-folder"></i>批量检测
            </button>
        </div>
    </div>
    
    <!-- 主内容区 -->
    <div class="main-content">
        <div class="header">
            <h1 id="mode-title">单张图像检测</h1>
        </div>
        
        <div class="upload-container">
            <!-- 单张上传区域 -->
            <div id="single-upload" class="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <p class="upload-text">点击或拖拽图片到此处</p>
                <p class="upload-hint">支持 JPG/PNG 格式图片</p>
                <input type="file" id="single-file-input" accept="image/*" style="display: none;">
            </div>
            
            <!-- 批量上传区域 -->
            <div id="batch-upload" class="upload-area" style="display: none;">
                <div class="upload-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <p class="upload-text">拖拽文件夹或选择多张图片</p>
                <p class="upload-hint">支持批量处理多张图片</p>
                <input type="file" id="batch-file-input" webkitdirectory directory multiple accept="image/*" style="display: none;">
            </div>
            
            <div class="progress-container" id="global-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress" id="global-progress-bar"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span id="progress-text">准备中...</span>
                    <span id="progress-percent">0%</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="process-btn" class="btn btn-primary" disabled>
                    <i class="fas fa-play"></i>开始检测
                </button>
                <button id="clear-btn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i>清空
                </button>
            </div>
        </div>
        
        <!-- 批量操作栏 -->
        <div class="batch-actions" id="batch-actions">
            <div class="batch-info">
                <span id="batch-count">已选择 0 个文件</span>
            </div>
            <button id="download-all-btn" class="btn btn-success" disabled>
                <i class="fas fa-download"></i>下载全部结果
            </button>
        </div>
        
        <!-- 预览区域 -->
        <div class="preview-container" id="results-container">
            <!-- 结果卡片将在这里动态生成 -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素引用
            const modeBtns = document.querySelectorAll('.mode-btn');
            const singleUpload = document.getElementById('single-upload');
            const batchUpload = document.getElementById('batch-upload');
            const singleFileInput = document.getElementById('single-file-input');
            const batchFileInput = document.getElementById('batch-file-input');
            const processBtn = document.getElementById('process-btn');
            const clearBtn = document.getElementById('clear-btn');
            const downloadAllBtn = document.getElementById('download-all-btn');
            const resultsContainer = document.getElementById('results-container');
            const modeTitle = document.getElementById('mode-title');
            const batchActions = document.getElementById('batch-actions');
            const batchCount = document.getElementById('batch-count');
            const globalProgress = document.getElementById('global-progress');
            const globalProgressBar = document.getElementById('global-progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressPercent = document.getElementById('progress-percent');
            
            // 状态变量
            let currentMode = 'single';
            let selectedFiles = [];
            let processing = false;
            
            // 初始化事件监听
            initEventListeners();
            
            function initEventListeners() {
                // 模式切换
                modeBtns.forEach(btn => {
                    btn.addEventListener('click', switchMode);
                });
                
                // 单张上传区域事件
                setupUploadArea(singleUpload, singleFileInput, false);
                
                // 批量上传区域事件
                setupUploadArea(batchUpload, batchFileInput, true);
                
                // 处理按钮
                processBtn.addEventListener('click', processFiles);
                
                // 清空按钮
                clearBtn.addEventListener('click', clearAll);
                
                // 下载全部按钮
                downloadAllBtn.addEventListener('click', downloadAllResults);
            }
            
            function switchMode(e) {
                // 切换活动按钮样式
                modeBtns.forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                // 更新当前模式
                currentMode = e.currentTarget.dataset.mode;
                modeTitle.textContent = currentMode === 'single' ? '单张图像检测' : '批量图像检测';
                
                // 切换上传区域显示
                singleUpload.style.display = currentMode === 'single' ? 'flex' : 'none';
                batchUpload.style.display = currentMode === 'batch' ? 'flex' : 'none';
                
                // 重置状态
                selectedFiles = [];
                updateProcessButton();
                clearResults();
                batchActions.style.display = 'none';
            }
            
            function setupUploadArea(uploadArea, fileInput, isBatch) {
                // 点击上传区域
                uploadArea.addEventListener('click', () => fileInput.click());
                
                // 拖拽事件
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('highlight');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('highlight');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('highlight');
                    
                    // 获取拖拽的文件
                    const files = isBatch ? getFilesFromDataTransfer(e.dataTransfer) : [e.dataTransfer.files[0]];
                    handleFileSelection(files, isBatch);
                });
                
                // 文件选择变化
                fileInput.addEventListener('change', () => {
                    const files = isBatch ? Array.from(fileInput.files) : [fileInput.files[0]];
                    handleFileSelection(files, isBatch);
                });
            }
            
            function getFilesFromDataTransfer(dataTransfer) {
                // 处理文件夹拖拽
                if (dataTransfer.items) {
                    const files = [];
                    for (let i = 0; i < dataTransfer.items.length; i++) {
                        if (dataTransfer.items[i].kind === 'file') {
                            const file = dataTransfer.items[i].getAsFile();
                            if (file) files.push(file);
                        }
                    }
                    return files.length > 0 ? files : Array.from(dataTransfer.files);
                }
                return Array.from(dataTransfer.files);
            }
            
            function handleFileSelection(files, isBatch) {
                // 过滤只保留图片文件
                const imageFiles = files.filter(file => file.type.match('image.*'));
                
                if (imageFiles.length === 0) {
                    alert('请选择有效的图片文件');
                    return;
                }
                
                if (!isBatch && imageFiles.length > 1) {
                    alert('单张模式只能选择一张图片');
                    return;
                }
                
                // 更新选中的文件
                selectedFiles = imageFiles;
                updateProcessButton();
                previewSelectedFiles();
                
                // 如果是批量模式，显示批量操作栏
                if (isBatch) {
                    batchActions.style.display = 'flex';
                    batchCount.textContent = `已选择 ${selectedFiles.length} 个文件`;
                }
            }
            
            function updateProcessButton() {
                processBtn.disabled = selectedFiles.length === 0 || processing;
            }
            
            function previewSelectedFiles() {
                clearResults();
                
                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        createImageCard(file, e.target.result, index);
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            function createImageCard(file, imageSrc, index) {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.dataset.index = index;
                card.dataset.filename = file.name;
                
                card.innerHTML = `
                    <div class="image-container">
                        <img src="${imageSrc}" alt="${file.name}">
                    </div>
                    <div class="image-info">
                        <div class="filename" title="${file.name}">${file.name}</div>
                        <div class="status waiting">等待处理</div>
                        <div class="action-buttons">
                            <button class="btn btn-primary download-btn" data-index="${index}" disabled>
                                <i class="fas fa-download"></i>下载
                            </button>
                            <button class="btn btn-danger remove-btn" data-index="${index}">
                                <i class="fas fa-times"></i>移除
                            </button>
                        </div>
                    </div>
                `;
                
                // 添加移除按钮事件
                const removeBtn = card.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => removeFile(index));
                
                resultsContainer.appendChild(card);
            }
            
            function removeFile(index) {
                selectedFiles.splice(index, 1);
                previewSelectedFiles();
                
                if (currentMode === 'batch') {
                    batchCount.textContent = `已选择 ${selectedFiles.length} 个文件`;
                    if (selectedFiles.length === 0) {
                        batchActions.style.display = 'none';
                    }
                }
                
                updateProcessButton();
            }
            
            function clearResults() {
                resultsContainer.innerHTML = '';
                downloadAllBtn.disabled = true;
            }
            
            function clearAll() {
                selectedFiles = [];
                updateProcessButton();
                clearResults();
                batchActions.style.display = 'none';
                
                // 重置文件输入
                singleFileInput.value = '';
                batchFileInput.value = '';
            }
            
            function processFiles() {
                if (selectedFiles.length === 0 || processing) return;
                
                processing = true;
                updateProcessButton();
                globalProgress.style.display = 'block';
                progressText.textContent = '处理中...';
                
                // 更新所有卡片状态为"处理中"
                document.querySelectorAll('.status').forEach(el => {
                    el.textContent = '处理中';
                    el.className = 'status processing';
                });
                
                if (currentMode === 'single') {
                    processSingleFile(selectedFiles[0], 0);
                } else {
                    processBatchFiles(selectedFiles);
                }
            }
            
            function processSingleFile(file, index) {
                const formData = new FormData();
                formData.append('image', file);
                
                // 更新进度条
                updateProgressBar(index, 0);
                
                fetch('/process-single', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error('处理失败');
                    return response.blob();
                })
                .then(blob => {
                    const resultUrl = URL.createObjectURL(blob);
                    updateResult(index, resultUrl, true);
                    updateProgressBar(index, 100);
                })
                .catch(error => {
                    console.error('处理出错:', error);
                    updateResult(index, null, false, error.message);
                })
                .finally(() => {
                    processing = false;
                    updateProcessButton();
                    progressText.textContent = '处理完成';
                });
            }
            
            function processBatchFiles(files) {
                let processedCount = 0;
                const totalFiles = files.length;
                
                files.forEach((file, index) => {
                    const formData = new FormData();
                    formData.append('images', file);
                    
                    fetch('/process-batch', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(`文件 ${file.name} 处理失败`);
                        return response.blob();
                    })
                    .then(blob => {
                        const resultUrl = URL.createObjectURL(blob);
                        updateResult(index, resultUrl, true);
                        
                        processedCount++;
                        const progress = Math.round((processedCount / totalFiles) * 100);
                        updateGlobalProgress(progress);
                        
                        if (processedCount === totalFiles) {
                            downloadAllBtn.disabled = false;
                            processing = false;
                            updateProcessButton();
                            progressText.textContent = '全部处理完成';
                        }
                    })
                    .catch(error => {
                        console.error(`处理文件 ${file.name} 出错:`, error);
                        updateResult(index, null, false, error.message);
                        
                        processedCount++;
                        if (processedCount === totalFiles) {
                            processing = false;
                            updateProcessButton();
                            progressText.textContent = '处理完成（部分失败）';
                        }
                    });
                });
            }
            
            function updateResult(index, resultUrl, success, errorMsg = null) {
                const card = document.querySelector(`.image-card[data-index="${index}"]`);
                if (!card) return;
                
                const statusEl = card.querySelector('.status');
                const downloadBtn = card.querySelector('.download-btn');
                
                if (success) {
                    statusEl.textContent = '处理成功';
                    statusEl.className = 'status success';
                    
                    // 更新图片显示
                    card.querySelector('img').src = resultUrl;
                    
                    // 启用下载按钮
                    downloadBtn.disabled = false;
                    downloadBtn.addEventListener('click', () => {
                        downloadImage(resultUrl, `processed_${card.dataset.filename}`);
                    });
                } else {
                    statusEl.textContent = errorMsg || '处理失败';
                    statusEl.className = 'status error';
                }
            }
            
            function updateProgressBar(index, percent) {
                const card = document.querySelector(`.image-card[data-index="${index}"]`);
                if (card) {
                    // 这里可以添加单个文件的进度条更新逻辑
                }
                
                // 更新全局进度
                updateGlobalProgress(percent);
            }
            
            function updateGlobalProgress(percent) {
                globalProgressBar.style.width = `${percent}%`;
                progressPercent.textContent = `${percent}%`;
            }
            
            function downloadImage(url, filename) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            async function downloadAllResults() {
                try {
                    // 创建ZIP包
                    const zip = new JSZip();
                    const imgFolder = zip.folder("processed_images");
                    let addedFiles = 0;
                    
                    // 收集所有处理成功的图片
                    const cards = document.querySelectorAll('.image-card');
                    const promises = Array.from(cards).map(async (card, index) => {
                        const status = card.querySelector('.status').textContent;
                        if (status === '处理成功') {
                            try {
                                const img = card.querySelector('img');
                                const response = await fetch(img.src);
                                const blob = await response.blob();
                                const filename = `processed_${card.dataset.filename}`;
                                imgFolder.file(filename, blob);
                                addedFiles++;
                            } catch (error) {
                                console.error(`无法添加文件 ${card.dataset.filename}:`, error);
                            }
                        }
                    });
                    
                    await Promise.all(promises);
                    
                    if (addedFiles === 0) {
                        alert('没有可下载的处理结果');
                        return;
                    }
                    
                    // 生成ZIP文件
                    progressText.textContent = '正在打包文件...';
                    const content = await zip.generateAsync({ type: "blob" }, (metadata) => {
                        const progress = Math.round(metadata.percent);
                        updateGlobalProgress(progress);
                    });
                    
                    // 下载ZIP文件
                    const zipUrl = URL.createObjectURL(content);
                    const link = document.createElement('a');
                    link.href = zipUrl;
                    link.download = 'processed_images.zip';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 释放内存
                    setTimeout(() => URL.revokeObjectURL(zipUrl), 100);
                    progressText.textContent = '下载完成';
                } catch (error) {
                    console.error('打包下载失败:', error);
                    alert('打包下载失败: ' + error.message);
                }
            }
        });
    </script>
</body>
</html>
