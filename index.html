<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä¸šæ£€æµ‹ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 220px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid #34495e;
        }
        
        .mode-selector {
            display: flex;
            flex-direction: column;
            padding: 15px 10px;
        }
        
        .mode-btn {
            padding: 12px 15px;
            margin: 5px 0;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
        }
        
        .mode-btn i {
            margin-right: 10px;
        }
        
        .mode-btn:hover {
            background: #3d566e;
        }
        
        .mode-btn.active {
            background: var(--primary-color);
            font-weight: 500;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        h1 {
            color: #2c3e50;
            margin: 0;
        }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-container {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 2px dashed #bdc3c7;
            padding: 40px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .upload-area.highlight {
            border-color: var(--primary-color);
            background-color: #f8fafb;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .upload-text {
            margin-bottom: 5px;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .upload-hint {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* é¢„è§ˆåŒºåŸŸ */
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
        }
        
        .image-container {
            position: relative;
            padding-top: 100%; /* 1:1æ¯”ä¾‹ */
            overflow: hidden;
        }
        
        .image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-info {
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .filename {
            font-weight: 500;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status.waiting {
            background: #f1f2f6;
            color: #7f8c8d;
        }
        
        .status.processing {
            background: #fff4e6;
            color: #e67e22;
        }
        
        .status.success {
            background: #e8f8f5;
            color: #27ae60;
        }
        
        .status.error {
            background: #fdecea;
            color: #e74c3c;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn i {
            margin-right: 6px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn:disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            margin-top: 15px;
        }
        
        .progress-bar {
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        /* æ‰¹é‡æ“ä½œæ  */
        .batch-actions {
            display: none;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .batch-info {
            display: flex;
            align-items: center;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 15px 0;
            }
            .mode-selector {
                flex-direction: row;
                overflow-x: auto;
                padding: 10px;
            }
            .mode-btn {
                white-space: nowrap;
                margin: 0 5px;
            }
        }
    </style>
    <!-- ä½¿ç”¨Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- JSZipåº“ç”¨äºæ‰“åŒ…ä¸‹è½½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <!-- ä¾§è¾¹å¯¼èˆªæ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>å·¥ä¸šæ£€æµ‹ç³»ç»Ÿ</h2>
        </div>
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="single">
                <i class="fas fa-image"></i>å•å¼ æ£€æµ‹
            </button>
            <button class="mode-btn" data-mode="batch">
                <i class="fas fa-folder"></i>æ‰¹é‡æ£€æµ‹
            </button>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="header">
            <h1 id="mode-title">å•å¼ å›¾åƒæ£€æµ‹</h1>
        </div>
        
        <div class="upload-container">
            <!-- å•å¼ ä¸Šä¼ åŒºåŸŸ -->
            <div id="single-upload" class="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                <p class="upload-hint">æ”¯æŒ JPG/PNG æ ¼å¼å›¾ç‰‡</p>
                <input type="file" id="single-file-input" accept="image/*" style="display: none;">
            </div>
            
            <!-- æ‰¹é‡ä¸Šä¼ åŒºåŸŸ -->
            <div id="batch-upload" class="upload-area" style="display: none;">
                <div class="upload-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <p class="upload-text">æ‹–æ‹½æ–‡ä»¶å¤¹æˆ–é€‰æ‹©å¤šå¼ å›¾ç‰‡</p>
                <p class="upload-hint">æ”¯æŒæ‰¹é‡å¤„ç†å¤šå¼ å›¾ç‰‡</p>
                <input type="file" id="batch-file-input" webkitdirectory directory multiple accept="image/*" style="display: none;">
            </div>
            
            <div class="progress-container" id="global-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress" id="global-progress-bar"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span id="progress-text">å‡†å¤‡ä¸­...</span>
                    <span id="progress-percent">0%</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="process-btn" class="btn btn-primary" disabled>
                    <i class="fas fa-play"></i>å¼€å§‹æ£€æµ‹
                </button>
                <button id="clear-btn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i>æ¸…ç©º
                </button>
            </div>
        </div>
        
        <!-- æ‰¹é‡æ“ä½œæ  -->
        <div class="batch-actions" id="batch-actions">
            <div class="batch-info">
                <span id="batch-count">å·²é€‰æ‹© 0 ä¸ªæ–‡ä»¶</span>
            </div>
            <button id="download-all-btn" class="btn btn-success" disabled>
                <i class="fas fa-download"></i>ä¸‹è½½å…¨éƒ¨ç»“æœ
            </button>
        </div>
        
        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-container" id="results-container">
            <!-- ç»“æœå¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        document.addEventListener('DOMContentLoaded', function() {
            // DOMå…ƒç´ å¼•ç”¨
            const modeBtns = document.querySelectorAll('.mode-btn');
            const singleUpload = document.getElementById('single-upload');
            const batchUpload = document.getElementById('batch-upload');
            const singleFileInput = document.getElementById('single-file-input');
            const batchFileInput = document.getElementById('batch-file-input');
            const processBtn = document.getElementById('process-btn');
            const clearBtn = document.getElementById('clear-btn');
            const downloadAllBtn = document.getElementById('download-all-btn');
            const resultsContainer = document.getElementById('results-container');
            const modeTitle = document.getElementById('mode-title');
            const batchActions = document.getElementById('batch-actions');
            const batchCount = document.getElementById('batch-count');
            const globalProgress = document.getElementById('global-progress');
            const globalProgressBar = document.getElementById('global-progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressPercent = document.getElementById('progress-percent');
            
            // çŠ¶æ€å˜é‡
            let currentMode = 'single';
            let selectedFiles = [];
            let processing = false;
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEventListeners();
            
            // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
            checkServerStatus();
            
            function checkServerStatus() {
                fetch(`${API_URL}/health`)
                    .then(response => {
                        if (response.ok) {
                            console.log('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                            showServerStatus(true);
                        } else {
                            throw new Error('æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                        }
                    })
                    .catch(error => {
                        console.error('âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                        showServerStatus(false);
                    });
            }
            
            function showServerStatus(isOnline) {
                // åˆ›å»ºæˆ–æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                let statusIndicator = document.getElementById('server-status');
                if (!statusIndicator) {
                    statusIndicator = document.createElement('div');
                    statusIndicator.id = 'server-status';
                    statusIndicator.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: 500;
                        z-index: 1000;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(statusIndicator);
                }
                
                if (isOnline) {
                    statusIndicator.textContent = 'ğŸŸ¢ æœåŠ¡å™¨åœ¨çº¿';
                    statusIndicator.style.background = '#e8f8f5';
                    statusIndicator.style.color = '#27ae60';
                    statusIndicator.style.border = '1px solid #27ae60';
                } else {
                    statusIndicator.textContent = 'ğŸ”´ æœåŠ¡å™¨ç¦»çº¿';
                    statusIndicator.style.background = '#fdf2f2';
                    statusIndicator.style.color = '#e74c3c';
                    statusIndicator.style.border = '1px solid #e74c3c';
                    
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    setTimeout(() => {
                        alert('âš ï¸ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼\n\nè¯·ç¡®ä¿ï¼š\n1. æœåŠ¡å™¨å·²å¯åŠ¨ (è¿è¡Œ node server.js)\n2. æœåŠ¡å™¨åœ°å€æ­£ç¡® (http://localhost:5000)\n3. æ²¡æœ‰é˜²ç«å¢™é˜»æ­¢è¿æ¥');
                    }, 1000);
                }
            }
            
            function initEventListeners() {
                // æ¨¡å¼åˆ‡æ¢
                modeBtns.forEach(btn => {
                    btn.addEventListener('click', switchMode);
                });
                
                // å•å¼ ä¸Šä¼ åŒºåŸŸäº‹ä»¶
                setupUploadArea(singleUpload, singleFileInput, false);
                
                // æ‰¹é‡ä¸Šä¼ åŒºåŸŸäº‹ä»¶
                setupUploadArea(batchUpload, batchFileInput, true);
                
                // å¤„ç†æŒ‰é’®
                processBtn.addEventListener('click', processFiles);
                
                // æ¸…ç©ºæŒ‰é’®
                clearBtn.addEventListener('click', clearAll);
                
                // ä¸‹è½½å…¨éƒ¨æŒ‰é’®
                downloadAllBtn.addEventListener('click', downloadAllResults);
            }
            
            function switchMode(e) {
                // åˆ‡æ¢æ´»åŠ¨æŒ‰é’®æ ·å¼
                modeBtns.forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                // æ›´æ–°å½“å‰æ¨¡å¼
                currentMode = e.currentTarget.dataset.mode;
                modeTitle.textContent = currentMode === 'single' ? 'å•å¼ å›¾åƒæ£€æµ‹' : 'æ‰¹é‡å›¾åƒæ£€æµ‹';
                
                // åˆ‡æ¢ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
                singleUpload.style.display = currentMode === 'single' ? 'flex' : 'none';
                batchUpload.style.display = currentMode === 'batch' ? 'flex' : 'none';
                
                // é‡ç½®çŠ¶æ€
                selectedFiles = [];
                updateProcessButton();
                clearResults();
                batchActions.style.display = 'none';
            }
            
            function setupUploadArea(uploadArea, fileInput, isBatch) {
                // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
                uploadArea.addEventListener('click', () => fileInput.click());
                
                // æ‹–æ‹½äº‹ä»¶
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('highlight');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('highlight');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('highlight');
                    
                    // è·å–æ‹–æ‹½çš„æ–‡ä»¶
                    const files = isBatch ? getFilesFromDataTransfer(e.dataTransfer) : [e.dataTransfer.files[0]];
                    handleFileSelection(files, isBatch);
                });
                
                // æ–‡ä»¶é€‰æ‹©å˜åŒ–
                fileInput.addEventListener('change', () => {
                    const files = isBatch ? Array.from(fileInput.files) : [fileInput.files[0]];
                    handleFileSelection(files, isBatch);
                });
            }
            
            function getFilesFromDataTransfer(dataTransfer) {
                // å¤„ç†æ–‡ä»¶å¤¹æ‹–æ‹½
                if (dataTransfer.items) {
                    const files = [];
                    for (let i = 0; i < dataTransfer.items.length; i++) {
                        if (dataTransfer.items[i].kind === 'file') {
                            const file = dataTransfer.items[i].getAsFile();
                            if (file) files.push(file);
                        }
                    }
                    return files.length > 0 ? files : Array.from(dataTransfer.files);
                }
                return Array.from(dataTransfer.files);
            }
            
            function handleFileSelection(files, isBatch) {
                // è¿‡æ»¤åªä¿ç•™å›¾ç‰‡æ–‡ä»¶
                const imageFiles = files.filter(file => file.type.match('image.*'));
                
                if (imageFiles.length === 0) {
                    alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                    return;
                }
                
                if (!isBatch && imageFiles.length > 1) {
                    alert('å•å¼ æ¨¡å¼åªèƒ½é€‰æ‹©ä¸€å¼ å›¾ç‰‡');
                    return;
                }
                
                // æ›´æ–°é€‰ä¸­çš„æ–‡ä»¶
                selectedFiles = imageFiles;
                updateProcessButton();
                previewSelectedFiles();
                
                // å¦‚æœæ˜¯æ‰¹é‡æ¨¡å¼ï¼Œæ˜¾ç¤ºæ‰¹é‡æ“ä½œæ 
                if (isBatch) {
                    batchActions.style.display = 'flex';
                    batchCount.textContent = `å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶`;
                }
            }
            
            function updateProcessButton() {
                processBtn.disabled = selectedFiles.length === 0 || processing;
            }
            
            function previewSelectedFiles() {
                clearResults();
                
                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        createImageCard(file, e.target.result, index);
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            function createImageCard(file, imageSrc, index) {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.dataset.index = index;
                card.dataset.filename = file.name;
                
                card.innerHTML = `
                    <div class="image-container">
                        <img src="${imageSrc}" alt="${file.name}">
                    </div>
                    <div class="image-info">
                        <div class="filename" title="${file.name}">${file.name}</div>
                        <div class="status waiting">ç­‰å¾…å¤„ç†</div>
                        <div class="action-buttons">
                            <button class="btn btn-primary download-btn" data-index="${index}" disabled>
                                <i class="fas fa-download"></i>ä¸‹è½½
                            </button>
                            <button class="btn btn-danger remove-btn" data-index="${index}">
                                <i class="fas fa-times"></i>ç§»é™¤
                            </button>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ ç§»é™¤æŒ‰é’®äº‹ä»¶
                const removeBtn = card.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => removeFile(index));
                
                resultsContainer.appendChild(card);
            }
            
            function removeFile(index) {
                selectedFiles.splice(index, 1);
                previewSelectedFiles();
                
                if (currentMode === 'batch') {
                    batchCount.textContent = `å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶`;
                    if (selectedFiles.length === 0) {
                        batchActions.style.display = 'none';
                    }
                }
                
                updateProcessButton();
            }
            
            function clearResults() {
                resultsContainer.innerHTML = '';
                downloadAllBtn.disabled = true;
            }
            
            function clearAll() {
                selectedFiles = [];
                updateProcessButton();
                clearResults();
                batchActions.style.display = 'none';
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                singleFileInput.value = '';
                batchFileInput.value = '';
            }
            
            function processFiles() {
                if (selectedFiles.length === 0 || processing) return;
                
                processing = true;
                updateProcessButton();
                globalProgress.style.display = 'block';
                progressText.textContent = 'å¤„ç†ä¸­...';
                
                // æ›´æ–°æ‰€æœ‰å¡ç‰‡çŠ¶æ€ä¸º"å¤„ç†ä¸­"
                document.querySelectorAll('.status').forEach(el => {
                    el.textContent = 'å¤„ç†ä¸­';
                    el.className = 'status processing';
                });
                
                if (currentMode === 'single') {
                    processSingleFile(selectedFiles[0], 0);
                } else {
                    processBatchFiles(selectedFiles);
                }
            }
            
            function processSingleFile(file, index) {
                const formData = new FormData();
                formData.append('image', file);
                
                // æ›´æ–°è¿›åº¦æ¡
                updateProgressBar(index, 0);
                
                fetch(`${API_URL}/process-single`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error('å¤„ç†å¤±è´¥');
                    return response.blob();
                })
                .then(blob => {
                    const resultUrl = URL.createObjectURL(blob);
                    updateResult(index, resultUrl, true);
                    updateProgressBar(index, 100);
                })
                .catch(error => {
                    console.error('å¤„ç†å‡ºé”™:', error);
                    updateResult(index, null, false, error.message);
                })
                .finally(() => {
                    processing = false;
                    updateProcessButton();
                    progressText.textContent = 'å¤„ç†å®Œæˆ';
                });
            }
            
            function processBatchFiles(files) {
                let processedCount = 0;
                const totalFiles = files.length;
                
                files.forEach((file, index) => {
                    const formData = new FormData();
                    formData.append('images', file);
                    
                    fetch(`${API_URL}/process-batch`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(`æ–‡ä»¶ ${file.name} å¤„ç†å¤±è´¥`);
                        return response.blob();
                    })
                    .then(blob => {
                        const resultUrl = URL.createObjectURL(blob);
                        updateResult(index, resultUrl, true);
                        
                        processedCount++;
                        const progress = Math.round((processedCount / totalFiles) * 100);
                        updateGlobalProgress(progress);
                        
                        if (processedCount === totalFiles) {
                            downloadAllBtn.disabled = false;
                            processing = false;
                            updateProcessButton();
                            progressText.textContent = 'å…¨éƒ¨å¤„ç†å®Œæˆ';
                        }
                    })
                    .catch(error => {
                        console.error(`å¤„ç†æ–‡ä»¶ ${file.name} å‡ºé”™:`, error);
                        updateResult(index, null, false, error.message);
                        
                        processedCount++;
                        if (processedCount === totalFiles) {
                            processing = false;
                            updateProcessButton();
                            progressText.textContent = 'å¤„ç†å®Œæˆï¼ˆéƒ¨åˆ†å¤±è´¥ï¼‰';
                        }
                    });
                });
            }
            
            function updateResult(index, resultUrl, success, errorMsg = null) {
                const card = document.querySelector(`.image-card[data-index="${index}"]`);
                if (!card) return;
                
                const statusEl = card.querySelector('.status');
                const downloadBtn = card.querySelector('.download-btn');
                
                if (success) {
                    statusEl.textContent = 'å¤„ç†æˆåŠŸ';
                    statusEl.className = 'status success';
                    
                    // æ›´æ–°å›¾ç‰‡æ˜¾ç¤º
                    card.querySelector('img').src = resultUrl;
                    
                    // å¯ç”¨ä¸‹è½½æŒ‰é’®
                    downloadBtn.disabled = false;
                    downloadBtn.addEventListener('click', () => {
                        downloadImage(resultUrl, `processed_${card.dataset.filename}`);
                    });
                } else {
                    statusEl.textContent = errorMsg || 'å¤„ç†å¤±è´¥';
                    statusEl.className = 'status error';
                }
            }
            
            function updateProgressBar(index, percent) {
                const card = document.querySelector(`.image-card[data-index="${index}"]`);
                if (card) {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å•ä¸ªæ–‡ä»¶çš„è¿›åº¦æ¡æ›´æ–°é€»è¾‘
                }
                
                // æ›´æ–°å…¨å±€è¿›åº¦
                updateGlobalProgress(percent);
            }
            
            function updateGlobalProgress(percent) {
                globalProgressBar.style.width = `${percent}%`;
                progressPercent.textContent = `${percent}%`;
            }
            
            function downloadImage(url, filename) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            async function downloadAllResults() {
                try {
                    // åˆ›å»ºZIPåŒ…
                    const zip = new JSZip();
                    const imgFolder = zip.folder("processed_images");
                    let addedFiles = 0;
                    
                    // æ”¶é›†æ‰€æœ‰å¤„ç†æˆåŠŸçš„å›¾ç‰‡
                    const cards = document.querySelectorAll('.image-card');
                    const promises = Array.from(cards).map(async (card, index) => {
                        const status = card.querySelector('.status').textContent;
                        if (status === 'å¤„ç†æˆåŠŸ') {
                            try {
                                const img = card.querySelector('img');
                                const response = await fetch(img.src);
                                const blob = await response.blob();
                                const filename = `processed_${card.dataset.filename}`;
                                imgFolder.file(filename, blob);
                                addedFiles++;
                            } catch (error) {
                                console.error(`æ— æ³•æ·»åŠ æ–‡ä»¶ ${card.dataset.filename}:`, error);
                            }
                        }
                    });
                    
                    await Promise.all(promises);
                    
                    if (addedFiles === 0) {
                        alert('æ²¡æœ‰å¯ä¸‹è½½çš„å¤„ç†ç»“æœ');
                        return;
                    }
                    
                    // ç”ŸæˆZIPæ–‡ä»¶
                    progressText.textContent = 'æ­£åœ¨æ‰“åŒ…æ–‡ä»¶...';
                    const content = await zip.generateAsync({ type: "blob" }, (metadata) => {
                        const progress = Math.round(metadata.percent);
                        updateGlobalProgress(progress);
                    });
                    
                    // ä¸‹è½½ZIPæ–‡ä»¶
                    const zipUrl = URL.createObjectURL(content);
                    const link = document.createElement('a');
                    link.href = zipUrl;
                    link.download = 'processed_images.zip';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // é‡Šæ”¾å†…å­˜
                    setTimeout(() => URL.revokeObjectURL(zipUrl), 100);
                    progressText.textContent = 'ä¸‹è½½å®Œæˆ';
                } catch (error) {
                    console.error('æ‰“åŒ…ä¸‹è½½å¤±è´¥:', error);
                    alert('æ‰“åŒ…ä¸‹è½½å¤±è´¥: ' + error.message);
                }
            }
        });
    </script>
</body>
</html>
